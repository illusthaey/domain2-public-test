<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light" />
  <title>방과후강사 월보수액 계산기</title>

  <link rel="stylesheet" href="/static/style.css" />

  <style>
    .page-title { margin-bottom: 6px; text-align: center; }
    .help-box { margin-top: 8px; }
    .table-wrap table { min-width: 1360px; } /* 고용보험 칸 추가로 폭 증가 */
    .sheetlike th { white-space: nowrap; }
    .sheetlike td { vertical-align: middle; }
    .num { text-align: right; }
    .name { min-width: 120px; }
    .rate { width: 110px; }
    .money { width: 160px; }
    .memo { min-width: 180px; }
    .idx { width: 60px; text-align: center; }
    .sumrow td { font-weight: 700; background: #fafafa; }
    .small { font-size: 0.95rem; color: #555; }
    .hint { font-size: 0.95rem; color:#666; margin: 8px 0 0; }

    /* 스크롤바가 설명을 덮지 않도록 */
    .table-wrap { padding-bottom: 14px; }

    .table-note { margin-top: 10px; }

    /* 표 하단 버튼 영역 */
    .table-actions {
      margin-top: 12px;
      display: flex;
      justify-content: flex-end;
    }
    .toolbar {
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content: flex-end;
    }
    .toolbar .btn { padding: 9px 14px; border-radius: 12px; }

    /* 상단 업로드 영역(표 위) */
    .table-actions.top-actions { justify-content: flex-start; margin-top: 8px; }

    /* 입력이 많은 칸들은 조금 더 타이트하게 */
    .sheetlike input { width: 100%; box-sizing: border-box; }

    @media (max-width: 920px) {
      .table-actions { justify-content: flex-start; }
      .toolbar { justify-content: flex-start; }
    }

    /* <li> 없이 tool-list를 쓰기 위한 보강 스타일 */
    .tool-list { margin: 10px 0 0; padding: 0; }
    .tool-list .tool-line { margin: 0 0 6px; }

    /* 기준 설정: 필요경비율 고정/수기변경 UI */
    .inline-row { display:flex; gap:10px; align-items:center; }
    .inline-row .chk { display:flex; gap:6px; align-items:center; white-space:nowrap; }
    #baseExpenseRate[disabled] { background:#f3f3f3; color:#555; cursor:not-allowed; }

    /* 표의 필요경비율은 기준설정 연동값(읽기전용처럼 보이게) */
    .sheetlike input[readonly] { background:#f3f3f3; color:#555; }
  </style>
</head>

<body>
  <header class="site-header">
    <div class="shell">
      <div>
        <h2 class="page-title">방과후강사 월보수액 계산기</h2>
        <div class="small">
          ·품의금액(강사료) 입력하면 월보수액 및 산재보험료 개인부담금 자동으로 산출해드립니다.<br/>
        </div>
      </div>

      <div class="card help-box">
        <div class="small">          
          ·관련: 강원도교육청 인성생활교육과-15279(2025.7.23.), 고용노동부 고시 제2025-34호 및 제2025-36호<br/>
          ·기본값: 필요경비율 14.9%, 산재보험요율(개인) 0.33%, 고용보험요율(개인) 0.8%, 기준보수 하한 1,330,000원 적용.<br/>
          ※ 월보수액이 80만원 이상~133만원 미만 구간에 해당하면 고용보험료 산정 시 월보수액을 1,330,000원으로 간주함.<br/>
        </div>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="section">
      <h3 class="local-h2 local-tight">기준 설정 (변경 가능)</h3>
      <div class="grid three">
        <div class="field">
          <label class="small">필요경비율(%)</label><br/>
          <div class="inline-row">
            <!-- 기본은 고정(비활성). 체크하면 수기 변경 가능 -->
            <input id="baseExpenseRate" type="number" step="0.1" value="14.9" disabled />
            <label class="small chk">
              <input type="checkbox" id="chkEditExpenseRate" />
              수기 변경
            </label>
          </div>
        </div>

        <div class="field">
          <label class="small">산재보험요율(개인)</label><br/>
          <input id="wcPersonalRate" type="number" step="0.01" value="0.33" />
        </div>

        <div class="field">
          <label class="small">기준보수 하한값</label><br/>
          <input id="floorMonthlyPay" type="number" step="10" value="1330000" />
        </div>
      </div>

      <p class="hint">
        ·필요경비율은 기본값(14.9%)으로 고정되어 있으며, 수기 변경에 체크 시 입력 가능합니다.<br/>
        ·기준 설정의 필요경비율을 바꾸면, 산출내역의 필요경비율도 전체 자동 변경되도록 연동되어있습니다.<br/>
        ·참고: 2024.7월~2025.6월 필요경비율 16.5%임.<br/>
      </p>
    </section>

    <section class="section">
      <h3 class="local-h2 local-tight">월보수액 산출내역</h3>

      <p class="small table-note">
        ·월보수액 =(강사료)-(필요경비), 원단위 절삭<br/>
        ·고용보험료는 예상값이며, 다른 학교 신고 내역에 따라 변동가능성 있음. 기관부담금 소요액 어느정도 나올지 예상하려고 기능 넣음.<br/>
        ·엑셀 쓰듯이 키보드 방향키로 자유롭게 이동 가능합니다. 편하쥬? <br/>
      </p>
      <div class="small" style="margin-top:6px; color:#666;">
        ·초기화 후 반영: 최초 업로드 시 또는 기존 내역이 있을 때는 싹 지우고 업로드 내용으로 반영합니다.<br/>
        ·추가 반영: 기존 표 입력 내용은 유지하면서 순서대로 추가함.<br/>
        ·업로드 서식에 강사명이랑 금액만 적어뒀는데 비고란 만들어서 문구 적으면 같이 반영되게 해둠.<br/>
      </div>
      
      <div class="table-actions top-actions">
        <div class="toolbar">
          <button class="btn ghost" id="btnDownloadTemplate" type="button">일괄 업로드용 서식 다운로드</button>

          <button class="btn ghost" id="btnUploadExcelReplace" type="button">엑셀 서식 업로드 (초기화 후 반영)</button>
          <button class="btn ghost" id="btnUploadExcelAppend" type="button">엑셀 서식 업로드 (추가 반영)</button>

          <input id="fileUploadExcel" type="file" accept=".xlsx,.xls,.csv" style="display:none" />
        </div>
      </div>

      <div class="table-wrap">
        <table class="sheetlike" id="calcTable">
          <thead>
            <tr>
              <th class="idx">순번</th>
              <th class="name">강사명</th>
              <th class="money">강사료 지급액</th>
              <th class="rate">필요경비율(%)</th>
              <th class="money">필요경비</th>
              <th class="money">월보수액</th>
              <th class="money">산재보험료(개인)</th>
              <th class="money">고용보험료(예상값)</th>
              <th class="memo">비고</th>
              <th>행</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
          <tfoot>
            <tr class="sumrow">
              <td>합계</td>
              <td></td>
              <td class="num" id="sumAmount">0</td>
              <td class="num">-</td>
              <td class="num" id="sumExpense">0</td>
              <td class="num" id="sumMonthlyPay">0</td>
              <td class="num" id="sumWcFee">0</td>
              <td class="num" id="sumEiFee">0</td>
              <td></td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="table-actions">
        <div class="toolbar">
          <button class="btn ghost" id="btnAddRow" type="button">행 추가하기</button>
          <button class="btn ghost" id="btnReset" type="button">초기화</button>
          <button class="btn primary" id="btnCopy" type="button">표 복사하기</button>
          <button class="btn ghost" id="btnDownloadExcel" type="button">계산결과 (엑셀) 다운로드</button>
          <button class="btn ghost" id="btnDownloadCsv" type="button">계산결과 (CSV) 다운로드</button>
        </div>
      </div>


    </section>

    <section class="section dl-section">
      <h2 class="local-h2">프로그램으로 다운로드 받기</h2>
      <hr/>

      <div class="tool-grid">
        <article class="tool-card">
          <header class="tool-head">
            <h3 class="tool-title">[사회보험료] 방과후강사 월보수액 계산기</h3>
          </header>

          <div class="tool-body">
            <div class="tool-list">
              <div class="tool-line">·웹페이지 기능과 동일한 구성의 프로그램입니다. 입력한 내용대로 엑셀파일 생성함.</div>
              <div class="tool-line">·PC에 저장해놓고 쓰는 게 더 편하면 다운로드 받아서 사용하십시오.</div>
            </div>

            <details class="shot-details">
              <summary class="shot-summary">프로그램 실행 화면 보기</summary>
              <figure class="tool-shot">
                <img src="/static/program_afterschool_teacher_01.jpg" alt="프로그램 실행 화면" class="tool-thumb" loading="lazy" /><br/>
                <img src="/static/program_afterschool_teacher_02.jpg" alt="생성된 엑셀파일 예시 화면 " class="tool-thumb" loading="lazy" /><br/>
              </figure>
            </details>
          </div>

          <a class="btn primary tool-btn" id="downloadafterschoolpay" href="#" download>
            [사회보험료] 방과후강사 월보수액 계산기 다운로드
          </a>
        </article>
      </div>
    </section>

      <div class="btns">
    <a class="btn" href="/">메인으로 돌아가기</a>
  </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <script>
    // =========================
    // 계산
    // =========================

    // 고용보험요율(개인) 기본값: 0.8%
    const EI_PERSONAL_RATE = 0.8 / 100.0;
    const MIN_ROWS_AFTER_UPLOAD = 10;

    function toInt(val) {
      if (val === null || val === undefined) return 0;
      const s = String(val).replace(/[^\d.-]/g, "");
      const n = Number(s);
      return Number.isFinite(n) ? n : 0;
    }

    // 원단위 절삭
    function cutWon10(n) {
      n = Math.floor(toInt(n));
      if (!Number.isFinite(n) || n <= 0) return 0;
      return Math.floor(n / 10) * 10;
    }

    // 천원 단위로 쉼표 넣기
    function fmt(n) {
      n = toInt(n);
      return n.toLocaleString("ko-KR");
    }

    function clampRate(r) {
      r = Number(r);
      if (!Number.isFinite(r)) return 0;
      if (r < 0) return 0;
      if (r > 100) return 100;
      return r;
    }

    function pad2(n) {
      return String(n).padStart(2, "0");
    }

    function ymd() {
      const d = new Date();
      return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
    }

    function downloadBlob(filename, mime, content) {
      const blob = new Blob([content], { type: mime });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function csvEscape(v) {
      const s = String(v ?? "");
      if (/[",\n\r]/.test(s)) return `"${s.replace(/"/g, '""')}"`;
      return s;
    }

    function ensureXlsx() {
      if (window.XLSX && typeof window.XLSX.read === "function" && typeof window.XLSX.writeFile === "function") {
        return true;
      }
      alert(
        "엑셀 기능을 불러오지 못했습니다.\n\n" +
        "- 네트워크 차단/보안SW/방화벽 또는 스크립트 로딩 실패 가능\n" +
        "- 임시로는 CSV 다운로드/업로드를 사용해 주세요."
      );
      return false;
    }

    // =========================
    // DOM
    // =========================
    const tbody = document.getElementById("tbody");

    const elBaseExpenseRate = document.getElementById("baseExpenseRate");
    const elChkEditExpenseRate = document.getElementById("chkEditExpenseRate");
    const elWcPersonalRate = document.getElementById("wcPersonalRate");
    const elFloorMonthlyPay = document.getElementById("floorMonthlyPay");

    const elSumAmount = document.getElementById("sumAmount");
    const elSumExpense = document.getElementById("sumExpense");
    const elSumMonthlyPay = document.getElementById("sumMonthlyPay");
    const elSumWcFee = document.getElementById("sumWcFee");
    const elSumEiFee = document.getElementById("sumEiFee");

    // =========================
    // 기준 설정: 필요경비율 잠금/해제
    // =========================
    function applyExpenseRateEditState() {
      const allowEdit = !!elChkEditExpenseRate.checked;
      elBaseExpenseRate.disabled = !allowEdit;
      elBaseExpenseRate.title = allowEdit ? "" : "수기 변경을 체크하면 수정할 수 있습니다.";
    }

    elChkEditExpenseRate.addEventListener("change", () => {
      applyExpenseRateEditState();
      if (!elBaseExpenseRate.disabled) {
        elBaseExpenseRate.focus();
        elBaseExpenseRate.select();
      }
    });

    // =========================
    // 표 렌더/계산
    // =========================
    function renumberRows() {
      const rows = [...tbody.querySelectorAll("tr")];
      rows.forEach((tr, i) => {
        const cell = tr.querySelector(".row-idx");
        if (cell) cell.textContent = String(i + 1);
      });
    }

    function makeRow(defaultRate) {
      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td class="idx row-idx">-</td>
        <td><input type="text" placeholder="예: 김교행" class="row-teacher"/></td>
        <td><input type="text" inputmode="numeric" placeholder="예: 1000000" class="row-amount num"/></td>
        <td><input type="number" step="0.1" value="${defaultRate}" class="row-rate num" readonly /></td>
        <td class="num row-expense">0</td>
        <td class="num row-monthly">0</td>
        <td class="num row-wcfee">0</td>
        <td class="num row-eifee">0</td>
        <td><input type="text" placeholder="메모용" class="row-memo"/></td>
        <td><button type="button" class="btn ghost row-del">삭제</button></td>
      `;

      tr.querySelector(".row-del").addEventListener("click", () => {
        tr.remove();
        renumberRows();
        recalcAll();
      });

      const amountInput = tr.querySelector(".row-amount");

      function normalizeMoneyInput(e) {
        const raw = e.target.value;
        const cleaned = raw.replace(/[^\d]/g, "");
        e.target.value = cleaned ? fmt(Number(cleaned)) : "";
        recalcRow(tr);
        recalcSums();
      }

      amountInput.addEventListener("input", normalizeMoneyInput);

      return tr;
    }

    function recalcRow(tr) {
      const baseExpenseRate = clampRate(elBaseExpenseRate.value);
      const wcPersonalRate = clampRate(elWcPersonalRate.value) / 100.0;
      const floorMonthlyPay = cutWon10(elFloorMonthlyPay.value);

      const amountStr = tr.querySelector(".row-amount").value;
      const amount = toInt(amountStr);

      // 필요경비율은 기준설정값으로 고정(표 칸은 표시용)
      const rate = baseExpenseRate;

      const expenseRaw = amount * (rate / 100.0);
      const expense = cutWon10(expenseRaw);

      const monthlyPay = cutWon10(Math.max(amount - expense, 0));

      // 산재보험료(개인) = 월보수액 * 개인부담율 (기준보수 하한 미적용)
      const wcFee = cutWon10(Math.floor(monthlyPay * wcPersonalRate));

      // 고용보험료(개인) = (월보수액 기준) * 0.8%
      // 기준보수 하한 적용 조건: 월보수액이 800,000원 이상 ~ 1,330,000원 미만이면 1,330,000원으로 간주
      const eiBase =
        (monthlyPay >= 800000 && monthlyPay < floorMonthlyPay) ? floorMonthlyPay : monthlyPay;
      const eiFee = cutWon10(Math.floor(eiBase * EI_PERSONAL_RATE));

      // 표시용 필요경비율 칸도 기준설정과 동기화
      const rateInput = tr.querySelector(".row-rate");
      if (rateInput) rateInput.value = baseExpenseRate;

      tr.querySelector(".row-expense").textContent = fmt(expense);
      tr.querySelector(".row-monthly").textContent = fmt(monthlyPay);
      tr.querySelector(".row-wcfee").textContent = fmt(wcFee);
      tr.querySelector(".row-eifee").textContent = fmt(eiFee);
    }

    function recalcSums() {
      let sumAmount = 0, sumExpense = 0, sumMonthly = 0, sumWc = 0, sumEi = 0;

      [...tbody.querySelectorAll("tr")].forEach(tr => {
        const amount = toInt(tr.querySelector(".row-amount").value);
        const expense = toInt(tr.querySelector(".row-expense").textContent);
        const monthly = toInt(tr.querySelector(".row-monthly").textContent);
        const wc = toInt(tr.querySelector(".row-wcfee").textContent);
        const ei = toInt(tr.querySelector(".row-eifee").textContent);

        sumAmount += amount;
        sumExpense += expense;
        sumMonthly += monthly;
        sumWc += wc;
        sumEi += ei;
      });

      elSumAmount.textContent = fmt(cutWon10(sumAmount));
      elSumExpense.textContent = fmt(cutWon10(sumExpense));
      elSumMonthlyPay.textContent = fmt(cutWon10(sumMonthly));
      elSumWcFee.textContent = fmt(cutWon10(sumWc));
      elSumEiFee.textContent = fmt(cutWon10(sumEi));
    }

    function recalcAll() {
      [...tbody.querySelectorAll("tr")].forEach(tr => recalcRow(tr));
      recalcSums();
    }

    // ✅ 기준 설정 필요경비율 변경 시: 산출내역 필요경비율도 전 행 연동
    function syncAllRowRatesFromBase() {
      const base = clampRate(elBaseExpenseRate.value);
      [...tbody.querySelectorAll("tr")].forEach(tr => {
        const rateInput = tr.querySelector(".row-rate");
        if (rateInput) rateInput.value = base;
      });
    }

    function collectRowsForExport() {
      const rows = [];
      const baseRate = clampRate(elBaseExpenseRate.value);

      [...tbody.querySelectorAll("tr")].forEach(tr => {
        const idx = tr.querySelector(".row-idx")?.textContent?.trim() || "";
        const teacher = tr.querySelector(".row-teacher").value.trim();
        const amount = toInt(tr.querySelector(".row-amount").value);
        const expense = toInt(tr.querySelector(".row-expense").textContent);
        const monthly = toInt(tr.querySelector(".row-monthly").textContent);
        const wc = toInt(tr.querySelector(".row-wcfee").textContent);
        const ei = toInt(tr.querySelector(".row-eifee").textContent);
        const memo = tr.querySelector(".row-memo").value.trim();

        if (!teacher && amount === 0 && !memo) return;

        rows.push({
          idx,
          teacher,
          amount,
          rate: baseRate,
          expense,
          monthly,
          wc,
          ei,
          memo
        });
      });
      return rows;
    }

    function buildCsvText() {
      const header = ["순번","강사명","품의금액","필요경비율(%)","필요경비","월보수액","산재보험료(개인)","고용보험료(개인)","비고"];
      const rows = collectRowsForExport();

      const lines = [];
      lines.push(header.map(csvEscape).join(","));
      rows.forEach(r => {
        lines.push([
          csvEscape(r.idx),
          csvEscape(r.teacher),
          csvEscape(r.amount),
          csvEscape(r.rate),
          csvEscape(r.expense),
          csvEscape(r.monthly),
          csvEscape(r.wc),
          csvEscape(r.ei),
          csvEscape(r.memo)
        ].join(","));
      });

      return "\uFEFF" + lines.join("\r\n");
    }

    function initRows(n = 10) {
      tbody.innerHTML = "";
      const defaultRate = clampRate(elBaseExpenseRate.value || 14.9);

      for (let i = 0; i < n; i++) {
        tbody.appendChild(makeRow(defaultRate));
      }
      renumberRows();
      recalcAll();
    }

    // =========================
    // ✅ 방향키/Enter로 셀 이동 (입력칸: 강사명/강사료/필요경비율/비고)
    // =========================
    const NAV_COL_ORDER = ["row-teacher", "row-amount", "row-rate", "row-memo"];

    function getColIndexFromInput(input) {
      for (let i = 0; i < NAV_COL_ORDER.length; i++) {
        if (input.classList.contains(NAV_COL_ORDER[i])) return i;
      }
      return -1;
    }

    function getRows() {
      return [...tbody.querySelectorAll("tr")];
    }

    function getInputAt(rowIdx, colIdx) {
      const rows = getRows();
      if (rowIdx < 0 || rowIdx >= rows.length) return null;
      const tr = rows[rowIdx];
      const cls = NAV_COL_ORDER[colIdx];
      return tr.querySelector("." + cls);
    }

    function caretAtStart(input) {
      if (typeof input.selectionStart !== "number" || typeof input.selectionEnd !== "number") return true;
      return input.selectionStart === 0 && input.selectionEnd === 0;
    }

    function caretAtEnd(input) {
      if (typeof input.selectionStart !== "number" || typeof input.selectionEnd !== "number") return true;
      const len = (input.value ?? "").length;
      return input.selectionStart === len && input.selectionEnd === len;
    }

    function focusAndSelect(input) {
      if (!input) return;
      input.focus();
      if (typeof input.select === "function") input.select();
      input.scrollIntoView({ block: "nearest", inline: "nearest" });
    }

    tbody.addEventListener("keydown", (e) => {
      const t = e.target;
      if (!(t instanceof HTMLInputElement)) return;

      const col = getColIndexFromInput(t);
      if (col === -1) return;

      const tr = t.closest("tr");
      if (!tr) return;

      let rows = getRows();
      let row = rows.indexOf(tr);
      if (row === -1) return;

      // 단축키 조합은 기본 동작 유지
      if (e.ctrlKey || e.altKey || e.metaKey) return;

      let nextRow = row;
      let nextCol = col;

      if (e.key === "Enter") {
        nextRow = e.shiftKey ? row - 1 : row + 1;

        // 마지막 행에서 Enter(아래로) 시 자동 행 추가
        if (!e.shiftKey && nextRow >= rows.length) {
          const defaultRate = clampRate(elBaseExpenseRate.value || 14.9);
          tbody.appendChild(makeRow(defaultRate));
          syncAllRowRatesFromBase();
          renumberRows();
          recalcAll();

          rows = getRows();
        }

        const next = getInputAt(nextRow, nextCol);
        if (!next) return;
        e.preventDefault();
        focusAndSelect(next);
        return;
      }

      if (e.key === "ArrowUp") {
        nextRow = row - 1;
      } else if (e.key === "ArrowDown") {
        nextRow = row + 1;
      } else if (e.key === "ArrowLeft") {
        if (!caretAtStart(t)) return;
        nextCol = col - 1;
      } else if (e.key === "ArrowRight") {
        if (!caretAtEnd(t)) return;
        nextCol = col + 1;
      } else {
        return;
      }

      if (nextCol < 0 || nextCol >= NAV_COL_ORDER.length) return;

      const next = getInputAt(nextRow, nextCol);
      if (!next) return;

      e.preventDefault();
      focusAndSelect(next);
    });

    // =========================
    // ✅ 엑셀 서식 다운로드 / 업로드
    // =========================
    function buildTemplateWorkbook() {
      // ✅ 비고(메모) 열 추가(선택 입력)
      const data = [["강사명", "강사료 지급액", "비고"]];
      for (let i = 0; i < 50; i++) data.push(["", "", ""]);
      const ws = XLSX.utils.aoa_to_sheet(data);
      ws["!cols"] = [{ wch: 18 }, { wch: 16 }, { wch: 20 }];

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "입력");
      return wb;
    }

    function buildTemplateCsvText() {
      const lines = [];
      lines.push(["강사명", "강사료 지급액", "비고"].map(csvEscape).join(","));
      for (let i = 0; i < 50; i++) lines.push(",,");
      return "\uFEFF" + lines.join("\r\n");
    }

    function normalizeHeaderCell(v) {
      return String(v ?? "").replace(/\s/g, "").toLowerCase();
    }

    function detectUploadColumns(headerRow) {
      const headers = (headerRow || []).map(normalizeHeaderCell);

      // name 후보: 강사명, 이름
      let nameIdx = headers.findIndex(h => h.includes("강사명") || h.includes("이름"));

      // amount 후보: 강사료, 품의금액, 지급액, (그냥 금액도 포함하되 필요경비/보험료는 제외)
      let amtIdx = headers.findIndex(h =>
        h.includes("강사료") ||
        h.includes("품의금액") ||
        h.includes("지급액") ||
        (h.includes("금액") && !h.includes("필요경비") && !h.includes("보험"))
      );

      // memo 후보: 비고, 메모
      let memoIdx = headers.findIndex(h => h.includes("비고") || h.includes("메모") || h.includes("memo"));
      if (memoIdx === -1) memoIdx = null;

      // 못 찾으면 기본: A=이름, B=금액
      if (nameIdx === -1) nameIdx = 0;
      if (amtIdx === -1) amtIdx = 1;

      // 혹시 같은 열로 잡히면, B로 밀기
      if (amtIdx === nameIdx) amtIdx = Math.min(nameIdx + 1, 1);

      return { nameIdx, amtIdx, memoIdx };
    }

    function parseCsvLine(line) {
      const out = [];
      let cur = "";
      let inQuotes = false;

      for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (inQuotes) {
          if (ch === '"') {
            if (line[i + 1] === '"') { cur += '"'; i++; }
            else inQuotes = false;
          } else {
            cur += ch;
          }
        } else {
          if (ch === '"') inQuotes = true;
          else if (ch === ",") { out.push(cur); cur = ""; }
          else cur += ch;
        }
      }
      out.push(cur);
      return out;
    }

    function parseCsvToRows(text) {
      const clean = String(text ?? "").replace(/^\uFEFF/, "");
      const lines = clean.split(/\r?\n/).filter(l => l.trim() !== "");
      if (lines.length < 2) return [];

      const header = parseCsvLine(lines[0]);
      const { nameIdx, amtIdx, memoIdx } = detectUploadColumns(header);

      const rows = [];
      for (let i = 1; i < lines.length; i++) {
        const cols = parseCsvLine(lines[i]);
        const teacher = String(cols[nameIdx] ?? "").trim();
        const amount = toInt(cols[amtIdx]);
        const memo = (memoIdx === null) ? "" : String(cols[memoIdx] ?? "").trim();

        if (!teacher && amount === 0 && !memo) continue;
        rows.push({ teacher, amount, memo });
      }
      return rows;
    }

    async function readUploadFileToRows(file) {
      const name = (file?.name || "").toLowerCase();
      if (name.endsWith(".csv")) {
        const text = await file.text();
        return parseCsvToRows(text);
      }

      if (!ensureXlsx()) throw new Error("XLSX 라이브러리를 불러오지 못했습니다.");

      const buf = await file.arrayBuffer();
      const wb = XLSX.read(buf, { type: "array" });
      const sheetName = wb.SheetNames?.[0];
      if (!sheetName) return [];

      const ws = wb.Sheets[sheetName];
      const aoa = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });

      if (!aoa || aoa.length < 2) return [];

      const headerRow = aoa[0] || [];
      const { nameIdx, amtIdx, memoIdx } = detectUploadColumns(headerRow);

      const rows = [];
      for (let r = 1; r < aoa.length; r++) {
        const line = aoa[r] || [];
        const teacher = String(line[nameIdx] ?? "").trim();
        const amount = toInt(line[amtIdx]);
        const memo = (memoIdx === null) ? "" : String(line[memoIdx] ?? "").trim();

        if (!teacher && amount === 0 && !memo) continue;
        rows.push({ teacher, amount, memo });
      }
      return rows;
    }

    function isRowEmpty(tr) {
      const teacher = tr.querySelector(".row-teacher")?.value?.trim() || "";
      const amount = toInt(tr.querySelector(".row-amount")?.value || "");
      const memo = tr.querySelector(".row-memo")?.value?.trim() || "";
      return !teacher && amount === 0 && !memo;
    }

    function fillRow(tr, r, defaultRate) {
      tr.querySelector(".row-teacher").value = r.teacher || "";
      tr.querySelector(".row-amount").value = r.amount ? fmt(r.amount) : "";
      tr.querySelector(".row-rate").value = defaultRate;
      tr.querySelector(".row-memo").value = r.memo || "";
    }

    function ensureMinRows(minRows) {
      const defaultRate = clampRate(elBaseExpenseRate.value || 14.9);
      while ([...tbody.querySelectorAll("tr")].length < minRows) {
        tbody.appendChild(makeRow(defaultRate));
      }
    }

    // mode: "replace" | "append"
    function applyRowsFromUpload(rows, mode = "replace") {
      const defaultRate = clampRate(elBaseExpenseRate.value || 14.9);

      if (mode === "append") {
        // 기존 빈 행 우선 채움 + 부족하면 행 생성
        if ([...tbody.querySelectorAll("tr")].length === 0) {
          ensureMinRows(MIN_ROWS_AFTER_UPLOAD);
        }

        rows.forEach(r => {
          let target = [...tbody.querySelectorAll("tr")].find(isRowEmpty);
          if (!target) {
            target = makeRow(defaultRate);
            tbody.appendChild(target);
          }
          fillRow(target, r, defaultRate);
        });

        ensureMinRows(MIN_ROWS_AFTER_UPLOAD);
      } else {
        // 교체(초기화 후 반영)
        tbody.innerHTML = "";
        const count = Math.max(rows.length, MIN_ROWS_AFTER_UPLOAD);

        for (let i = 0; i < count; i++) {
          const tr = makeRow(defaultRate);
          tbody.appendChild(tr);

          const r = rows[i];
          if (r) fillRow(tr, r, defaultRate);
        }
      }

      syncAllRowRatesFromBase();
      renumberRows();
      recalcAll();
    }

    // =========================
    // ✅ 결과 엑셀(.xlsx) 생성
    // =========================
    function buildResultWorkbook() {
      const rows = collectRowsForExport();
      const header = ["순번","강사명","강사료 지급액","필요경비율(%)","필요경비","월보수액","산재보험료(개인)","고용보험료(개인, 예상값)","비고"];

      const data = [header];
      rows.forEach(r => {
        data.push([
          (toInt(r.idx) || ""),
          r.teacher,
          toInt(r.amount),
          Number(r.rate),
          toInt(r.expense),
          toInt(r.monthly),
          toInt(r.wc),
          toInt(r.ei),
          r.memo
        ]);
      });

      const ws = XLSX.utils.aoa_to_sheet(data);
      ws["!cols"] = [
        { wch: 6 }, { wch: 14 }, { wch: 16 }, { wch: 14 },
        { wch: 14 }, { wch: 14 }, { wch: 18 }, { wch: 22 }, { wch: 20 }
      ];

      const cfg = [
        ["항목", "값"],
        ["필요경비율(%)", clampRate(elBaseExpenseRate.value)],
        ["산재보험료율(개인)(%)", clampRate(elWcPersonalRate.value)],
        ["고용보험요율(개인)(%)", EI_PERSONAL_RATE * 100],
        ["기준보수 하한값", cutWon10(elFloorMonthlyPay.value)]
      ];
      const wsCfg = XLSX.utils.aoa_to_sheet(cfg);
      wsCfg["!cols"] = [{ wch: 22 }, { wch: 18 }];

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "월보수액");
      XLSX.utils.book_append_sheet(wb, wsCfg, "기준설정");
      return wb;
    }

    // =========================
    // 이벤트 바인딩
    // =========================
    // ✅ 기준 설정 값 변경
    elBaseExpenseRate.addEventListener("input", () => {
      syncAllRowRatesFromBase();
      recalcAll();
    });

    [elWcPersonalRate, elFloorMonthlyPay].forEach(el => {
      el.addEventListener("input", () => recalcAll());
    });

    document.getElementById("btnAddRow").addEventListener("click", () => {
      const defaultRate = clampRate(elBaseExpenseRate.value || 14.9);
      tbody.appendChild(makeRow(defaultRate));
      syncAllRowRatesFromBase();
      renumberRows();
      recalcAll();
    });

    document.getElementById("btnReset").addEventListener("click", () => {
      elChkEditExpenseRate.checked = false;

      // 값 초기화
      elBaseExpenseRate.value = "14.9";
      elWcPersonalRate.value = "0.33";
      elFloorMonthlyPay.value = "1330000";

      // 잠금 적용 + 행 초기화
      applyExpenseRateEditState();
      initRows(10);
    });

    // ✅ CSV 다운로드
    document.getElementById("btnDownloadCsv").addEventListener("click", () => {
      const csv = buildCsvText();
      const filename = `방과후강사_월보수액_${ymd()}.csv`;
      downloadBlob(filename, "text/csv;charset=utf-8", csv);
    });

    // ✅ 결과 엑셀 다운로드(.xlsx)
    document.getElementById("btnDownloadExcel").addEventListener("click", () => {
      if (!ensureXlsx()) return;
      const wb = buildResultWorkbook();
      const filename = `방과후강사_월보수액_${ymd()}.xlsx`;
      XLSX.writeFile(wb, filename);
    });

    // ✅ 표 복사하기
    document.getElementById("btnCopy").addEventListener("click", async () => {
      const lines = [];
      lines.push(["순번","강사명","품의금액","필요경비율(%)","필요경비","월보수액","산재보험료(개인)","고용보험료(개인)","비고"].join("\t"));

      collectRowsForExport().forEach(r => {
        lines.push([
          r.idx, r.teacher, r.amount, r.rate, r.expense, r.monthly, r.wc, r.ei, r.memo
        ].join("\t"));
      });

      const text = lines.join("\n");
      try {
        await navigator.clipboard.writeText(text);
        alert("복사 완료.");
      } catch (e) {
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
        alert("복사 완료. 고주무관 천재");
      }
    });

    // ✅ 엑셀 서식 다운로드
    document.getElementById("btnDownloadTemplate").addEventListener("click", () => {
      const date = ymd();
      if (ensureXlsx()) {
        const wb = buildTemplateWorkbook();
        XLSX.writeFile(wb, `방과후강사_입력서식_${date}.xlsx`);
      } else {
        const csv = buildTemplateCsvText();
        downloadBlob(`방과후강사_입력서식_${date}.csv`, "text/csv;charset=utf-8", csv);
      }
    });

    // ✅ 엑셀 업로드(버튼 분리: 교체/추가)
    const elFileUpload = document.getElementById("fileUploadExcel");
    let pendingUploadMode = "replace";

    document.getElementById("btnUploadExcelReplace").addEventListener("click", () => {
      pendingUploadMode = "replace";
      elFileUpload.click();
    });

    document.getElementById("btnUploadExcelAppend").addEventListener("click", () => {
      pendingUploadMode = "append";
      elFileUpload.click();
    });

    elFileUpload.addEventListener("change", async (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;

      try {
        const rows = await readUploadFileToRows(file);
        applyRowsFromUpload(rows, pendingUploadMode);
        alert(`엑셀 반영 완료: ${rows.length}명`);
      } catch (err) {
        console.error(err);
        alert("엑셀 업로드 처리 중 오류가 발생했습니다.\n\n" + (err?.message || String(err)));
      } finally {
        // 같은 파일 다시 선택 가능하도록 초기화
        e.target.value = "";
        pendingUploadMode = "replace";
      }
    });

    // =========================
    // 초기 실행
    // =========================
    applyExpenseRateEditState();  // 기본: 필요경비율 잠금
    initRows(10);

    const afterschoolpay_URL =
      "https://github.com/comicshaey/FILErealease/releases/download/exe-to-excel/monthlypayv260201v1.exe";

    const afterschoolpay = document.getElementById("downloadafterschoolpay");
    if (afterschoolpay) afterschoolpay.href = afterschoolpay_URL;
  </script>



  <script src="/static/disable-copy.js"></script>
  <script src="/static/footer.js"></script>
  <script src="/static/global-loader.js?v=1"></script>
</body>
</html>
